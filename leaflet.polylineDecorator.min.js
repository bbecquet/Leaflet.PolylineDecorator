L.LineUtil.PolylineDecorator={computeAngle:function(a,b){return Math.atan2(b.y-a.y,b.x-a.x)*180/Math.PI+90},getPointPathPixelLength:function(pts){var nbPts=pts.length;if(nbPts<2){return 0}var dist=0,prevPt=pts[0],pt;for(var i=1;i<nbPts;i++){dist+=prevPt.distanceTo(pt=pts[i]);prevPt=pt}return dist},getPixelLength:function(pl,map){var ll=pl instanceof L.Polyline?pl.getLatLngs():pl,nbPts=ll.length;if(nbPts<2){return 0}var dist=0,prevPt=map.project(ll[0]),pt;for(var i=1;i<nbPts;i++){dist+=prevPt.distanceTo(pt=map.project(ll[i]));prevPt=pt}return dist},projectPatternOnPath:function(path,offsetRatio,repeatRatio,map){var pathAsPoints=[],i;for(i=0,l=path.length;i<l;i++){pathAsPoints[i]=map.project(path[i])}var pattern=this.projectPatternOnPointPath(pathAsPoints,offsetRatio,repeatRatio);for(i=0,l=pattern.length;i<l;i++){pattern[i].latLng=map.unproject(pattern[i].pt)}return pattern},projectPatternOnPointPath:function(pts,offsetRatio,repeatRatio){var positions=[];var repeatIntervalLength=this.getPointPathPixelLength(pts)*repeatRatio;var previous=this.interpolateOnPointPath(pts,offsetRatio);positions.push(previous);if(repeatRatio>0){var remainingPath=pts;remainingPath=remainingPath.slice(previous.predecessor);remainingPath[0]=previous.pt;var remainingLength=this.getPointPathPixelLength(remainingPath);while(repeatIntervalLength<=remainingLength){previous=this.interpolateOnPointPath(remainingPath,repeatIntervalLength/remainingLength);positions.push(previous);remainingPath=remainingPath.slice(previous.predecessor);remainingPath[0]=previous.pt;remainingLength=this.getPointPathPixelLength(remainingPath)}}return positions},interpolateOnPointPath:function(pts,ratio){var nbVertices=pts.length;if(nbVertices<2){return null}if(ratio<=0){return{pt:pts[0],predecessor:0,heading:this.computeAngle(pts[0],pts[1])}}if(ratio>=1){return{pt:pts[nbVertices-1],predecessor:nbVertices-1,heading:this.computeAngle(pts[nbVertices-2],pts[nbVertices-1])}}if(nbVertices==2){return{pt:this.interpolateBetweenPoints(pts[0],pts[1],ratio),predecessor:0,heading:this.computeAngle(pts[0],pts[1])}}var pathLength=this.getPointPathPixelLength(pts);var a=pts[0],b=a,ratioA=0,ratioB=0,distB=0;var i=1;for(;i<nbVertices&&ratioB<ratio;i++){a=b;ratioA=ratioB;b=pts[i];distB+=a.distanceTo(b);ratioB=distB/pathLength}var segmentRatio=(ratio-ratioA)/(ratioB-ratioA);return{pt:this.interpolateBetweenPoints(a,b,segmentRatio),predecessor:i-2,heading:this.computeAngle(a,b)}},interpolateBetweenPoints:function(ptA,ptB,ratio){if(ptB.x!=ptA.x){return new L.Point(ptA.x*(1-ratio)+ratio*ptB.x,ptA.y*(1-ratio)+ratio*ptB.y)}return new L.Point(ptA.x,ptA.y+(ptB.y-ptA.y)*ratio)}};L.RotatedMarker=L.Marker.extend({options:{angle:0},_setPos:function(pos){L.Marker.prototype._setPos.call(this,pos);if(L.DomUtil.TRANSFORM){this._icon.style[L.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)"}else if(L.Browser.ie){var rad=this.options.angle*L.LatLng.DEG_TO_RAD,costheta=Math.cos(rad),sintheta=Math.sin(rad);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+costheta+", M12="+-sintheta+", M21="+sintheta+", M22="+costheta+")"}}});L.rotatedMarker=function(pos,options){return new L.RotatedMarker(pos,options)};L.Symbol=L.Symbol||{};L.Symbol.Dash=L.Class.extend({isZoomDependant:true,options:{pixelSize:10,pathOptions:{}},initialize:function(options){L.Util.setOptions(this,options);this.options.pathOptions.clickable=false},buildSymbol:function(dirPoint,latLngs,map,index,total){var opts=this.options;if(opts.pixelSize<=1){return new L.Polyline([dirPoint.latLng,dirPoint.latLng],opts.pathOptions)}var midPoint=map.project(dirPoint.latLng);var angle=-(dirPoint.heading-90)*L.LatLng.DEG_TO_RAD;var a=new L.Point(midPoint.x+opts.pixelSize*Math.cos(angle+Math.PI)/2,midPoint.y+opts.pixelSize*Math.sin(angle)/2);var b=midPoint.add(midPoint.subtract(a));return new L.Polyline([map.unproject(a),map.unproject(b)],opts.pathOptions)}});L.Symbol.dash=function(options){return new L.Symbol.Dash(options)};L.Symbol.ArrowHead=L.Class.extend({isZoomDependant:true,options:{polygon:true,pixelSize:10,headAngle:60,pathOptions:{stroke:false,weight:2}},initialize:function(options){L.Util.setOptions(this,options);this.options.pathOptions.clickable=false},buildSymbol:function(dirPoint,latLngs,map,index,total){var opts=this.options;var path;if(opts.polygon){path=new L.Polygon(this._buildArrowPath(dirPoint,map),opts.pathOptions)}else{path=new L.Polyline(this._buildArrowPath(dirPoint,map),opts.pathOptions)}return path},_buildArrowPath:function(dirPoint,map){var tipPoint=map.project(dirPoint.latLng);var direction=-(dirPoint.heading-90)*L.LatLng.DEG_TO_RAD;var radianArrowAngle=this.options.headAngle/2*L.LatLng.DEG_TO_RAD;var headAngle1=direction+radianArrowAngle,headAngle2=direction-radianArrowAngle;var arrowHead1=new L.Point(tipPoint.x-this.options.pixelSize*Math.cos(headAngle1),tipPoint.y+this.options.pixelSize*Math.sin(headAngle1)),arrowHead2=new L.Point(tipPoint.x-this.options.pixelSize*Math.cos(headAngle2),tipPoint.y+this.options.pixelSize*Math.sin(headAngle2));return[map.unproject(arrowHead1),dirPoint.latLng,map.unproject(arrowHead2)]}});L.Symbol.arrowHead=function(options){return new L.Symbol.ArrowHead(options)};L.Symbol.Marker=L.Class.extend({isZoomDependant:false,options:{markerOptions:{},rotate:false},initialize:function(options){L.Util.setOptions(this,options);this.options.markerOptions.clickable=false;this.options.markerOptions.draggable=false;this.isZoomDependant=L.Browser.ie&&this.options.rotate},buildSymbol:function(directionPoint,latLngs,map,index,total){if(!this.options.rotate){return new L.Marker(directionPoint.latLng,this.options.markerOptions)}else{this.options.markerOptions.angle=directionPoint.heading;return new L.RotatedMarker(directionPoint.latLng,this.options.markerOptions)}}});L.Symbol.marker=function(options){return new L.Symbol.Marker(options)};L.PolylineDecorator=L.LayerGroup.extend({options:{patterns:[]},initialize:function(paths,options){L.LayerGroup.prototype.initialize.call(this);L.Util.setOptions(this,options);this._map=null;this._initPaths(paths);this._initPatterns()},_initPaths:function(p){this._paths=[];var isPolygon=false;if(p instanceof L.MultiPolyline||(isPolygon=p instanceof L.MultiPolygon)){var lines=p.getLatLngs();for(var i=0;i<lines.length;i++){this._initPath(lines[i],isPolygon)}}else if(p instanceof L.Polyline){this._initPath(p.getLatLngs(),p instanceof L.Polygon)}else if(L.Util.isArray(p)&&p.length>0){if(p[0]instanceof L.Polyline){for(var i=0;i<p.length;i++){this._initPath(p[i].getLatLngs(),p[i]instanceof L.Polygon)}}else{this._initPath(p)}}},_isCoordArray:function(ll){return L.Util.isArray(ll)&&ll.length>0&&(ll[0]instanceof L.LatLng||L.Util.isArray(ll[0])&&ll[0].length==2&&typeof ll[0][0]==="number")},_initPath:function(path,isPolygon){var latLngs;if(this._isCoordArray(path)){latLngs=[path]}else{latLngs=path}for(var i=0;i<latLngs.length;i++){if(isPolygon){latLngs[i].push(latLngs[i][0])}this._paths.push(latLngs[i])}},_initPatterns:function(){this._isZoomDependant=false;this._patterns=[];var pattern;for(var i=0;i<this.options.patterns.length;i++){pattern=this._parsePatternDef(this.options.patterns[i]);this._patterns.push(pattern);this._isZoomDependant=this._isZoomDependant||pattern.isOffsetInPixels||pattern.isRepeatInPixels||pattern.symbolFactory.isZoomDependant}},setPatterns:function(patterns){this.options.patterns=patterns;this._initPatterns();this._softRedraw()},setPaths:function(paths){this._initPaths(paths);this.redraw()},_parsePatternDef:function(patternDef,latLngs){var pattern={cache:[],symbolFactory:patternDef.symbol,isOffsetInPixels:false,isRepeatInPixels:false};if(typeof patternDef.offset==="string"&&patternDef.offset.indexOf("%")!=-1){pattern.offset=parseFloat(patternDef.offset)/100}else{pattern.offset=parseFloat(patternDef.offset);pattern.isOffsetInPixels=pattern.offset>0}if(typeof patternDef.repeat==="string"&&patternDef.repeat.indexOf("%")!=-1){pattern.repeat=parseFloat(patternDef.repeat)/100}else{pattern.repeat=parseFloat(patternDef.repeat);pattern.isRepeatInPixels=pattern.repeat>0}return pattern},onAdd:function(map){this._map=map;this._draw();if(this._isZoomDependant){this._map.on("moveend",this._softRedraw,this)}},onRemove:function(map){this._map.off("moveend",this._softRedraw,this);this._map=null;L.LayerGroup.prototype.onRemove.call(this,map)},_buildSymbols:function(latLngs,symbolFactory,directionPoints){var symbols=[];for(var i=0,l=directionPoints.length;i<l;i++){symbols.push(symbolFactory.buildSymbol(directionPoints[i],latLngs,this._map,i,l))}return symbols},_getCache:function(pattern,zoom,pathIndex){var zoomCache=pattern.cache[zoom];if(typeof zoomCache==="undefined"){pattern.cache[zoom]=[];return null}return zoomCache[pathIndex]},_getDirectionPoints:function(pathIndex,pattern){var zoom=this._map.getZoom();var dirPoints=this._getCache(pattern,zoom,pathIndex);if(dirPoints){return dirPoints}var offset,repeat,pathPixelLength=null,latLngs=this._paths[pathIndex];if(pattern.isOffsetInPixels){pathPixelLength=L.LineUtil.PolylineDecorator.getPixelLength(latLngs,this._map);offset=pattern.offset/pathPixelLength}else{offset=pattern.offset}if(pattern.isRepeatInPixels){pathPixelLength=pathPixelLength!==null?pathPixelLength:L.LineUtil.PolylineDecorator.getPixelLength(latLngs,this._map);repeat=pattern.repeat/pathPixelLength}else{repeat=pattern.repeat}dirPoints=L.LineUtil.PolylineDecorator.projectPatternOnPath(latLngs,offset,repeat,this._map);pattern.cache[zoom][pathIndex]=dirPoints;return dirPoints},redraw:function(){this._redraw(true)},_softRedraw:function(){this._redraw(false)},_redraw:function(clearCache){if(this._map===null)return;this.clearLayers();if(clearCache){for(var i=0;i<this._patterns.length;i++){this._patterns[i].cache=[]}}this._draw()},_drawPattern:function(pattern){var directionPoints,symbols;for(var i=0;i<this._paths.length;i++){directionPoints=this._getDirectionPoints(i,pattern);symbols=this._buildSymbols(this._paths[i],pattern.symbolFactory,directionPoints);for(var j=0;j<symbols.length;j++){if(this._map.getBounds().contains(symbols[j]._latlng)){this.addLayer(symbols[j])}}}},_draw:function(){for(var i=0;i<this._patterns.length;i++){this._drawPattern(this._patterns[i])}}});L.polylineDecorator=function(paths,options){return new L.PolylineDecorator(paths,options)};